/**
 * @file Firebase Security Rules for CreatorX SEO Platform
 *
 * @core_philosophy This ruleset enforces a strict user-ownership model for personal data nested under `/users/{userId}` and provides public read access to a few collections of non-sensitive data. It also protects data consistency by enforcing immutable owner fields on updates.
 * @data_structure Data is organized hierarchically:
 *   - `/users/{userId}`: Stores user profile information.
 *   - `/users/{userId}/channelAccounts/{channelAccountId}`: Stores channel accounts linked to a user.
 *   - `/users/{userId}/contentIdeas/{contentIdeaId}`: Stores content ideas created by a user.
 *   - `/users/{userId}/whatsAppSessions/{sessionId}`: Stores WhatsApp session data for a user.
 *   - `/channelAccounts/{channelAccountId}/videoMetrics/{videoMetricsId}`: Stores video metrics associated with a channel account.
 *   - `/trendEvents/{trendEventId}`: Stores trending events (publicly readable).
 *   - `/subscriptions/{subscriptionId}`: Stores subscription data.
 *   - `/keywords/{keywordId}`: Stores keyword data (publicly readable).
 *   - `/competitors/{competitorId}`: Stores competitor data (publicly readable).
 * @key_security_decisions
 *   - User data is strictly owned and controlled by the authenticated user.
 *   - Public collections (`trendEvents`, `keywords`, `competitors`) are readable by all.
 *   - Data consistency is enforced by validating owner fields on `create` and ensuring immutability on `update`.
 *   - Listing of collections under `/users/{userId}` is restricted to the owning user.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Allows users to manage their own profile data.
     * @path /users/{userId}
     * @allow (create) - Authenticated user creates their own profile with matching userId: `request.auth.uid == 'user_abc'` and `request.resource.data.id == 'user_abc'`.
     * @allow (get, update, delete) - Authenticated user reads, updates, or deletes their own profile: `request.auth.uid == 'user_abc'` where `userId` in the path is `user_abc`.
     * @deny (create) - Authenticated user attempts to create a profile for a different user: `request.auth.uid == 'user_abc'` but `request.resource.data.id == 'user_xyz'`.
     * @deny (update, delete) - Authenticated user attempts to update or delete another user's profile: `request.auth.uid == 'user_abc'` but the `userId` in the path is `user_xyz`.
     * @principle Enforces document ownership and validates relational integrity.
     */
    match /users/{userId} {
      function isOwner(userId) {
        return request.auth != null && request.auth.uid == userId;
      }
      function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }

      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId) && request.resource.data.id == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.id == resource.data.id;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Allows users to manage their own channel accounts.
     * @path /users/{userId}/channelAccounts/{channelAccountId}
     * @allow (create) - Authenticated user creates a channel account under their profile: `request.auth.uid == 'user_abc'` where `userId` in the path is `user_abc`.
     * @allow (get, list, update, delete) - Authenticated user reads, lists, updates, or deletes a channel account under their profile: `request.auth.uid == 'user_abc'` where `userId` in the path is `user_abc`.
     * @deny (create) - Authenticated user attempts to create a channel account under another user's profile: `request.auth.uid == 'user_abc'` but the `userId` in the path is `user_xyz`.
     * @deny (update, delete) - Authenticated user attempts to update or delete a channel account under another user's profile: `request.auth.uid == 'user_abc'` but the `userId` in the path is `user_xyz`.
     * @principle Enforces document ownership via path and requires user authentication.
     */
    match /users/{userId}/channelAccounts/{channelAccountId} {
      function isOwner(userId) {
        return request.auth != null && request.auth.uid == userId;
      }
       function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }

      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Allows users to manage their own content ideas.
     * @path /users/{userId}/contentIdeas/{contentIdeaId}
     * @allow (create) - Authenticated user creates a content idea under their profile: `request.auth.uid == 'user_abc'` where `userId` in the path is `user_abc`.
     * @allow (get, list, update, delete) - Authenticated user reads, lists, updates, or deletes a content idea under their profile: `request.auth.uid == 'user_abc'` where `userId` in the path is `user_abc`.
     * @deny (create) - Authenticated user attempts to create a content idea under another user's profile: `request.auth.uid == 'user_abc'` but the `userId` in the path is `user_xyz`.
     * @deny (update, delete) - Authenticated user attempts to update or delete a content idea under another user's profile: `request.auth.uid == 'user_abc'` but the `userId` in the path is `user_xyz`.
     * @principle Enforces document ownership via path and requires user authentication.
     */
    match /users/{userId}/contentIdeas/{contentIdeaId} {
      function isOwner(userId) {
        return request.auth != null && request.auth.uid == userId;
      }
       function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }

      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Allows users to manage their own WhatsApp sessions.
     * @path /users/{userId}/whatsAppSessions/{sessionId}
     * @allow (create) - Authenticated user creates a WhatsApp session under their profile: `request.auth.uid == 'user_abc'` where `userId` in the path is `user_abc`.
     * @allow (get, list, update, delete) - Authenticated user reads, lists, updates, or deletes a WhatsApp session under their profile: `request.auth.uid == 'user_abc'` where `userId` in the path is `user_abc`.
     * @deny (create) - Authenticated user attempts to create a WhatsApp session under another user's profile: `request.auth.uid == 'user_abc'` but the `userId` in the path is `user_xyz`.
     * @deny (update, delete) - Authenticated user attempts to update or delete a WhatsApp session under another user's profile: `request.auth.uid == 'user_abc'` but the `userId` in the path is `user_xyz`.
     * @principle Enforces document ownership via path and requires user authentication.
     */
    match /users/{userId}/whatsAppSessions/{sessionId} {
      function isOwner(userId) {
        return request.auth != null && request.auth.uid == userId;
      }
       function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }

      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Allows anyone to read trending events; write operations are disallowed.
     * @path /trendEvents/{trendEventId}
     * @allow (get, list) - Any user, authenticated or not, can read trending events.
     * @deny (create, update, delete) - No one can create, update, or delete a trending event via the client.
     * @principle Public read access with restricted write access.
     */
    match /trendEvents/{trendEventId} {
      allow get: if true;
      allow list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

     /**
     * @description Allows anyone to read keyword data; write operations are disallowed.
     * @path /keywords/{keywordId}
     * @allow (get, list) - Any user, authenticated or not, can read keywords.
     * @deny (create, update, delete) - No one can create, update, or delete a keyword via the client.
     * @principle Public read access with restricted write access.
     */
    match /keywords/{keywordId} {
      allow get: if true;
      allow list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Allows anyone to read competitor data; write operations are disallowed.
     * @path /competitors/{competitorId}
     * @allow (get, list) - Any user, authenticated or not, can read competitor data.
     * @deny (create, update, delete) - No one can create, update, or delete a competitor via the client.
     * @principle Public read access with restricted write access.
     */
    match /competitors/{competitorId} {
      allow get: if true;
      allow list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

   /**
     * @description Allows management of video metrics associated with a channel account.
     *  No ownership is enforced here, so access is completely disallowed.
     *  The data model is incomplete, therefore rules are unsafe.
     * @path /channelAccounts/{channelAccountId}/videoMetrics/{videoMetricsId}
     * @deny (get, list, create, update, delete) - All operations are denied due to missing ownership/authorization logic.
     * @principle: Deny all access until authorization is defined
     */
    match /channelAccounts/{channelAccountId}/videoMetrics/{videoMetricsId} {
        allow get: if false;
        allow list: if false;
        allow create: if false;
        allow update: if false;
        allow delete: if false;
    }

    /**
     * @description Allows management of subscription data.
     * No ownership is enforced here, so access is completely disallowed.
     * The data model is incomplete, therefore rules are unsafe.
     * @path /subscriptions/{subscriptionId}
     * @deny (get, list, create, update, delete) - All operations are denied due to missing ownership/authorization logic.
     * @principle: Deny all access until authorization is defined
     */
    match /subscriptions/{subscriptionId} {
        allow get: if false;
        allow list: if false;
        allow create: if false;
        allow update: if false;
        allow delete: if false;
    }
  }
}