/**
 * @file Firestore Security Rules
 * @description This ruleset enforces a strict user-ownership model for private data and allows public read access for shared content.
 *
 * Data Structure:
 * - /users/{userId}: Stores private user data. Access is restricted to the authenticated user.
 * - /users/{userId}/channelAccounts/{channelAccountId}: Channel accounts owned by the user.
 * - /users/{userId}/contentIdeas/{contentIdeaId}: Content ideas owned by the user.
 * - /users/{userId}/whatsAppSessions/{sessionId}: WhatsApp sessions owned by the user.
 * - /channelAccounts/{channelAccountId}/videoMetrics/{videoMetricsId}: Video metrics for a given channel account.
 * - /trendEvents/{trendEventId}: Public trending events.
 * - /subscriptions/{subscriptionId}: Subscription information.
 * - /keywords/{keywordId}: Public keyword data.
 * - /competitors/{competitorId}: Public competitor data.
 * - /blogPosts/{postId}: Public blog posts.
 * - /blogPosts/{postId}/comments/{commentId}: Comments on public blog posts.
 *
 * Key Security Decisions:
 * - User-owned data is stored under /users/{userId} to simplify ownership checks.
 * - Public data (TrendEvents, Keywords, Competitors, BlogPosts, BlogComments) is stored in top-level collections, allowing public read access.
 * - All write operations on user-owned data require authentication and ownership validation.
 * - Blog posts are publicly readable, but write access is restricted to owners.
 * - Blog comments are publicly readable, but only authenticated users can create them.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Enforces access control for user profiles.
     * @path /users/{userId}
     * @allow (create) Authenticated user can create their own profile.
     * @allow (get, list, update, delete) Authenticated user can only access their own profile.
     * @deny (create) Unauthenticated users cannot create profiles.
     * @deny (get, list, update, delete) Users cannot access other user profiles.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId} {
      function isSignedIn() {
        return request.auth != null;
      }
      function isOwner(userId) {
        return request.auth.uid == userId;
      }
      function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }

      allow get: if isSignedIn() && isOwner(userId);
      allow list: if false;
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isSignedIn() && isExistingOwner(userId);
      allow delete: if isSignedIn() && isExistingOwner(userId);
    }

    /**
     * @description Enforces access control for channel accounts owned by a user.
     * @path /users/{userId}/channelAccounts/{channelAccountId}
     * @allow (create) Authenticated user can create channel accounts under their profile.
     * @allow (get, list, update, delete) Authenticated user can only access channel accounts under their profile.
     * @deny (create) Unauthenticated users cannot create channel accounts.
     * @deny (get, list, update, delete) Users cannot access channel accounts under other user profiles.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId}/channelAccounts/{channelAccountId} {
      function isSignedIn() {
        return request.auth != null;
      }
      function isOwner(userId) {
        return request.auth.uid == userId;
      }
      function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }

      allow get: if isSignedIn() && isOwner(userId);
      allow list: if isSignedIn() && isOwner(userId);
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isSignedIn() && isExistingOwner(userId);
      allow delete: if isSignedIn() && isExistingOwner(userId);
    }

    /**
     * @description Enforces access control for content ideas owned by a user.
     * @path /users/{userId}/contentIdeas/{contentIdeaId}
     * @allow (create) Authenticated user can create content ideas under their profile.
     * @allow (get, list, update, delete) Authenticated user can only access content ideas under their profile.
     * @deny (create) Unauthenticated users cannot create content ideas.
     * @deny (get, list, update, delete) Users cannot access content ideas under other user profiles.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId}/contentIdeas/{contentIdeaId} {
      function isSignedIn() {
        return request.auth != null;
      }
      function isOwner(userId) {
        return request.auth.uid == userId;
      }
      function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }

      allow get: if isSignedIn() && isOwner(userId);
      allow list: if isSignedIn() && isOwner(userId);
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isSignedIn() && isExistingOwner(userId);
      allow delete: if isSignedIn() && isExistingOwner(userId);
    }

    /**
     * @description Enforces access control for WhatsApp sessions owned by a user.
     * @path /users/{userId}/whatsAppSessions/{sessionId}
     * @allow (create) Authenticated user can create WhatsApp sessions under their profile.
     * @allow (get, list, update, delete) Authenticated user can only access WhatsApp sessions under their profile.
     * @deny (create) Unauthenticated users cannot create WhatsApp sessions.
     * @deny (get, list, update, delete) Users cannot access WhatsApp sessions under other user profiles.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId}/whatsAppSessions/{sessionId} {
      function isSignedIn() {
        return request.auth != null;
      }
      function isOwner(userId) {
        return request.auth.uid == userId;
      }
      function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }

      allow get: if isSignedIn() && isOwner(userId);
      allow list: if isSignedIn() && isOwner(userId);
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isSignedIn() && isExistingOwner(userId);
      allow delete: if isSignedIn() && isExistingOwner(userId);
    }

    /**
     * @description Enforces access control for video metrics associated with a channel account.
     * @path /channelAccounts/{channelAccountId}/videoMetrics/{videoMetricsId}
     * @allow (get, list) Anyone can read video metrics.
     * @deny (create, update, delete) No one can create, update, or delete video metrics.
     * @principle Read-only access for video metrics.
     */
    match /channelAccounts/{channelAccountId}/videoMetrics/{videoMetricsId} {
      allow get: if true;
      allow list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Allows public read access to trending events.
     * @path /trendEvents/{trendEventId}
     * @allow (get, list) Anyone can read trending events.
     * @deny (create, update, delete) No one can create, update, or delete trending events.
     * @principle Public read access for trending events.
     */
    match /trendEvents/{trendEventId} {
      allow get: if true;
      allow list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Enforces access control for subscription data.
     * @path /subscriptions/{subscriptionId}
     * @deny (get, list, create, update, delete) No one can access subscription data.
     * @principle No access to subscription data.
     */
    match /subscriptions/{subscriptionId} {
      allow get: if false;
      allow list: if false;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Allows public read access to keyword data.
     * @path /keywords/{keywordId}
     * @allow (get, list) Anyone can read keyword data.
     * @deny (create, update, delete) No one can create, update, or delete keyword data.
     * @principle Public read access for keyword data.
     */
    match /keywords/{keywordId} {
      allow get: if true;
      allow list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Allows public read access to competitor data.
     * @path /competitors/{competitorId}
     * @allow (get, list) Anyone can read competitor data.
     * @deny (create, update, delete) No one can create, update, or delete competitor data.
     * @principle Public read access for competitor data.
     */
    match /competitors/{competitorId} {
      allow get: if true;
      allow list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Allows public read access to blog posts, but restricts writes to owners.
     * @path /blogPosts/{postId}
     * @allow (get, list) Anyone can read blog posts.
     * @allow (create) Only authenticated users can create blog posts, with matching authorId.
     * @allow (update, delete) Only the author can update or delete their blog post.
     * @deny (create) Unauthenticated users can't create blog posts.
     * @deny (update, delete) Non-authors can't update or delete blog posts.
     * @principle Public read, owner-only writes for blog posts.
     */
    match /blogPosts/{postId} {
      function isSignedIn() {
        return request.auth != null;
      }
      function isOwner(authorId) {
        return request.auth.uid == authorId;
      }
      function isExistingOwner(authorId) {
          return isSignedIn() && isOwner(authorId) && resource != null;
      }
      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn() && request.resource.data.authorId == request.auth.uid;
      allow update: if isExistingOwner(resource.data.authorId);
      allow delete: if isExistingOwner(resource.data.authorId);
    }

    /**
     * @description Allows public read access to blog comments, but restricts creation to authenticated users.
     * @path /blogPosts/{postId}/comments/{commentId}
     * @allow (get, list) Anyone can read blog comments.
     * @allow (create) Only authenticated users can create blog comments.
     * @deny (create) Unauthenticated users can't create blog comments.
     * @deny (update, delete) No one can update or delete blog comments.
     * @principle Public read, authenticated-user-only creation for blog comments.
     */
    match /blogPosts/{postId}/comments/{commentId} {
      function isSignedIn() {
        return request.auth != null;
      }
      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn();
      allow update: if false;
      allow delete: if false;
    }
  }
}