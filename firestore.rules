rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if the user is signed in
    function isSignedIn() {
      return request.auth != null;
    }

    // Helper function to check if the authenticated user is the owner of the resource
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    // Helper function to check if the authenticated user is the existing owner of the resource
    function isExistingOwner(userId) {
        return request.auth.uid == resource.data.userId;
    }

    /**
     * @description Rules for the /users/{userId} collection.
     * @path /users/{userId}
     * @allow (create) Authenticated user can create their own user document if the userId matches their auth.uid.
     * @allow (get, list, update, delete) Authenticated user can only access their own user document.
     * @deny (create) User attempts to create a user document with an ID that doesn't match their auth.uid.
     * @principle Enforces user-ownership; Users can only manage their own profile.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false; // Listing all users is not permitted.
      allow create: if isSignedIn() && request.auth.uid == userId;
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }

    /**
     * @description Rules for the /users/{userId}/channelAccounts/{channelAccountId} collection.
     * @path /users/{userId}/channelAccounts/{channelAccountId}
     * @allow (create) Authenticated user can create channel accounts under their user document.
     * @allow (get, list, update, delete) Authenticated user can only access their own channel accounts.
     * @deny (create) User attempts to create a channel account under another user's document.
     * @principle Enforces user-ownership; Users can only manage their own channel accounts.
     */
    match /users/{userId}/channelAccounts/{channelAccountId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isSignedIn() && request.auth.uid == userId;
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }

    /**
     * @description Rules for the /users/{userId}/contentIdeas/{contentIdeaId} collection.
     * @path /users/{userId}/contentIdeas/{contentIdeaId}
     * @allow (create) Authenticated user can create content ideas under their user document.
     * @allow (get, list, update, delete) Authenticated user can only access their own content ideas.
     * @deny (create) User attempts to create a content idea under another user's document.
     * @principle Enforces user-ownership; Users can only manage their own content ideas.
     */
    match /users/{userId}/contentIdeas/{contentIdeaId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isSignedIn() && request.auth.uid == userId;
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }

    /**
     * @description Rules for the /users/{userId}/whatsAppSessions/{sessionId} collection.
     * @path /users/{userId}/whatsAppSessions/{sessionId}
     * @allow (create) Authenticated user can create WhatsApp sessions under their user document.
     * @allow (get, list, update, delete) Authenticated user can only access their own WhatsApp sessions.
     * @deny (create) User attempts to create a WhatsApp session under another user's document.
     * @principle Enforces user-ownership; Users can only manage their own WhatsApp sessions.
     */
    match /users/{userId}/whatsAppSessions/{sessionId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isSignedIn() && request.auth.uid == userId;
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }

    /**
     * @description Rules for the /channelAccounts/{channelAccountId}/videoMetrics/{videoMetricsId} collection.
     * @path /channelAccounts/{channelAccountId}/videoMetrics/{videoMetricsId}
     * @allow (create) Anyone can create video metrics. // TODO: Add proper authorization.
     * @allow (get, list) Anyone can read video metrics.  // TODO: Add proper authorization.
     * @allow (update, delete) No one can update or delete video metrics. // TODO: Add proper authorization.
     * @principle  // TODO: Add proper authorization.
     */
    match /channelAccounts/{channelAccountId}/videoMetrics/{videoMetricsId} {
      allow get: if isSignedIn();  // Only signed in users can read
      allow list: if isSignedIn();    // Only signed in users can list
      allow create: if isSignedIn();    // Only signed in users can create
      allow update: if false;    // No one can update
      allow delete: if false;    // No one can delete
    }

    /**
     * @description Rules for the /trendEvents/{trendEventId} collection.
     * @path /trendEvents/{trendEventId}
     * @allow (get, list) Anyone can read trend events.
     * @deny (create, update, delete) No one can create, update, or delete trend events. // TODO: Add proper authorization.
     * @principle Public read access with owner-only writes. // TODO: Add proper authorization.
     */
    match /trendEvents/{trendEventId} {
      allow get: if true; // Anyone can read
      allow list: if true;    // Anyone can list
      allow create: if isSignedIn();    // Only signed in users can create
      allow update: if false;    // No one can update
      allow delete: if false;    // No one can delete
    }

    /**
     * @description Rules for the /subscriptions/{subscriptionId} collection.
     * @path /subscriptions/{subscriptionId}
     * @allow (get, list) Anyone can read subscriptions. // TODO: Add proper authorization.
     * @deny (create, update, delete) No one can create, update, or delete subscriptions. // TODO: Add proper authorization.
     * @principle Public read access with owner-only writes. // TODO: Add proper authorization.
     */
    match /subscriptions/{subscriptionId} {
      allow get: if isSignedIn();  // Only signed in users can read
      allow list: if isSignedIn();    // Only signed in users can list
      allow create: if isSignedIn();    // Only signed in users can create
      allow update: if false;    // No one can update
      allow delete: if false;    // No one can delete
    }

    /**
     * @description Rules for the /keywords/{keywordId} collection.
     * @path /keywords/{keywordId}
     * @allow (get, list) Anyone can read keywords.
     * @deny (create, update, delete) No one can create, update, or delete keywords.  // TODO: Add proper authorization.
     * @principle Public read access. // TODO: Add proper authorization for write access.
     */
    match /keywords/{keywordId} {
      allow get: if true; //Anyone can read
      allow list: if true;    //Anyone can list
      allow create: if isSignedIn();    // Only signed in users can create
      allow update: if false;    // No one can update
      allow delete: if false;    // No one can delete
    }

    /**
     * @description Rules for the /competitors/{competitorId} collection.
     * @path /competitors/{competitorId}
     * @allow (get, list) Anyone can read competitors.
     * @deny (create, update, delete) No one can create, update, or delete competitors. // TODO: Add proper authorization.
     * @principle Public read access.  // TODO: Add proper authorization for write access.
     */
    match /competitors/{competitorId} {
      allow get: if true; //Anyone can read
      allow list: if true;    //Anyone can list
      allow create: if isSignedIn();    // Only signed in users can create
      allow update: if false;    // No one can update
      allow delete: if false;    // No one can delete
    }
  }
}