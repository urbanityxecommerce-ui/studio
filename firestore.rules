rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Protects user profiles, ensuring only the authenticated user can access their own profile.
     * @path /users/{userId}
     * @allow (create) User with ID matching auth UID can create their profile.
     * @allow (get, update, delete) Authenticated user can access their own profile.
     * @deny (create) User with ID not matching auth UID cannot create a profile.
     * @deny (get, update, delete) Authenticated user cannot access another user's profile.
     * @deny (list) Listing all users is not allowed.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
          return isOwner(userId) && resource.data != null;
      }

      allow get: if isSignedIn() && isOwner(userId);
      allow list: if false;
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isSignedIn() && isExistingOwner(userId);
      allow delete: if isSignedIn() && isExistingOwner(userId);
    }

    /**
     * @description Manages channel accounts, ensuring only the owning user can access their channel accounts.
     * @path /users/{userId}/channelAccounts/{channelAccountId}
     * @allow (create) Authenticated user can create a channel account under their profile.
     * @allow (get, update, delete) Authenticated user can access their own channel accounts.
     * @deny (create) Authenticated user cannot create a channel account under another user's profile.
     * @deny (get, update, delete) Authenticated user cannot access another user's channel accounts.
     * @deny (list) Authenticated user can list their own channel accounts.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId}/channelAccounts/{channelAccountId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
          return isOwner(userId) && resource.data != null;
      }

      allow get: if isSignedIn() && isOwner(userId);
      allow list: if isSignedIn() && isOwner(userId);
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isSignedIn() && isExistingOwner(userId);
      allow delete: if isSignedIn() && isExistingOwner(userId);
    }

    /**
     * @description Manages content ideas, ensuring only the owning user can access their content ideas.
     * @path /users/{userId}/contentIdeas/{contentIdeaId}
     * @allow (create) Authenticated user can create a content idea under their profile.
     * @allow (get, update, delete) Authenticated user can access their own content ideas.
     * @deny (create) Authenticated user cannot create a content idea under another user's profile.
     * @deny (get, update, delete) Authenticated user cannot access another user's content ideas.
     * @deny (list) Authenticated user can list their own content ideas.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId}/contentIdeas/{contentIdeaId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
          return isOwner(userId) && resource.data != null;
      }

      allow get: if isSignedIn() && isOwner(userId);
      allow list: if isSignedIn() && isOwner(userId);
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isSignedIn() && isExistingOwner(userId);
      allow delete: if isSignedIn() && isExistingOwner(userId);
    }

     /**
      * @description Manages WhatsApp sessions, ensuring only the owning user can access their WhatsApp sessions.
      * @path /users/{userId}/whatsAppSessions/{sessionId}
      * @allow (create) Authenticated user can create a WhatsApp session under their profile.
      * @allow (get, update, delete) Authenticated user can access their own WhatsApp sessions.
      * @deny (create) Authenticated user cannot create a WhatsApp session under another user's profile.
      * @deny (get, update, delete) Authenticated user cannot access another user's WhatsApp sessions.
      * @deny (list) Authenticated user can list their own WhatsApp sessions.
      * @principle Enforces document ownership for all operations.
      */
    match /users/{userId}/whatsAppSessions/{sessionId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
          return isOwner(userId) && resource.data != null;
      }

      allow get: if isSignedIn() && isOwner(userId);
      allow list: if isSignedIn() && isOwner(userId);
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isSignedIn() && isExistingOwner(userId);
      allow delete: if isSignedIn() && isExistingOwner(userId);
    }

    /**
     * @description Manages video metrics associated with a channel account.
     * @path /channelAccounts/{channelAccountId}/videoMetrics/{videoMetricsId}
     * @allow (get, list) Any user can read video metrics.
     * @deny (create, update, delete) No one can create, update, or delete video metrics.
     * @principle Public read, no write access.
     */
    match /channelAccounts/{channelAccountId}/videoMetrics/{videoMetricsId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Manages trending events, allowing public read access.
     * @path /trendEvents/{trendEventId}
     * @allow (get, list) Any user can read trending events.
     * @deny (create, update, delete) No one can create, update, or delete trending events.
     * @principle Public read, no write access.
     */
    match /trendEvents/{trendEventId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Manages subscription data.
     * @path /subscriptions/{subscriptionId}
     * @allow (get, list) Any user can read subscription data.
     * @deny (create, update, delete) No one can create, update, or delete subscription data.
     * @principle Public read, no write access.
     */
    match /subscriptions/{subscriptionId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Manages keyword data, allowing public read access.
     * @path /keywords/{keywordId}
     * @allow (get, list) Any user can read keyword data.
     * @deny (create, update, delete) No one can create, update, or delete keyword data.
     * @principle Public read, no write access.
     */
    match /keywords/{keywordId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Manages competitor data, allowing public read access.
     * @path /competitors/{competitorId}
     * @allow (get, list) Any user can read competitor data.
     * @deny (create, update, delete) No one can create, update, or delete competitor data.
     * @principle Public read, no write access.
     */
    match /competitors/{competitorId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }
  }
}