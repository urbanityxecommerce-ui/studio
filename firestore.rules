/**
 * @file Firebase Security Rules for CreatorX SEO Platform
 *
 * @core_philosophy This ruleset enforces a strict user-ownership model for personal data while allowing public read access to shared SEO data.
 * All user-specific data is nested under the `/users/{userId}` path, enabling simple, path-based authorization.
 * @data_structure
 * - `/users/{userId}`: Stores user profile data.
 * - `/users/{userId}/channelAccounts/{channelAccountId}`: Stores channel accounts linked to a user.
 * - `/users/{userId}/contentIdeas/{contentIdeaId}`: Stores content ideas generated by a user.
 * - `/users/{userId}/whatsAppSessions/{sessionId}`: Stores WhatsApp session data for a user.
 * - `/channelAccounts/{channelAccountId}/videoMetrics/{videoMetricsId}`: Stores video metrics associated with a channel account.
 * - `/trendEvents/{trendEventId}`: Stores trending event data (publicly readable).
 * - `/subscriptions/{subscriptionId}`: Stores subscription data.
 * - `/keywords/{keywordId}`: Stores keyword data (publicly readable).
 * - `/competitors/{competitorId}`: Stores competitor data (publicly readable).
 * @key_security_decisions
 * - User data is strictly controlled by the owning user.
 * - Public SEO data (keywords, competitors, trend events) is readable by all.
 * - Listing of user documents is allowed only to the owner.
 * @denormalization_for_authorization Not applicable. Path-based ownership is used instead.
 * @structural_segregation Private user data is stored under `/users/{userId}`, while public data resides in top-level collections.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Controls access to user profile data.
     * @path /users/{userId}
     * @allow (create) User with ID 'user123' can create their profile. request.auth.uid == 'user123'
     * @allow (get) User with ID 'user123' can read their profile. request.auth.uid == 'user123'
     * @allow (update) User with ID 'user123' can update their profile. request.auth.uid == 'user123'
     * @allow (delete) User with ID 'user123' can delete their profile. request.auth.uid == 'user123'
     * @deny (create) User with ID 'user456' cannot create a profile for 'user123'. request.auth.uid != 'user123'
     * @deny (get) User with ID 'user456' cannot read the profile of 'user123'. request.auth.uid != 'user123'
     * @deny (update) User with ID 'user456' cannot update the profile of 'user123'. request.auth.uid != 'user123'
     * @deny (delete) User with ID 'user456' cannot delete the profile of 'user123'. request.auth.uid != 'user123'
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId) && request.resource.data.id == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.id == resource.data.id;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Controls access to channel accounts associated with a user.
     * @path /users/{userId}/channelAccounts/{channelAccountId}
     * @allow (create) User with ID 'user123' can create a channel account. request.auth.uid == 'user123'
     * @allow (get) User with ID 'user123' can read their channel account. request.auth.uid == 'user123'
     * @allow (update) User with ID 'user123' can update their channel account. request.auth.uid == 'user123'
     * @allow (delete) User with ID 'user123' can delete their channel account. request.auth.uid == 'user123'
     * @deny (create) User with ID 'user456' cannot create a channel account for 'user123'. request.auth.uid != 'user123'
     * @deny (get) User with ID 'user456' cannot read the channel account of 'user123'. request.auth.uid != 'user123'
     * @deny (update) User with ID 'user456' cannot update the channel account of 'user123'. request.auth.uid != 'user123'
     * @deny (delete) User with ID 'user456' cannot delete the channel account of 'user123'. request.auth.uid != 'user123'
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId}/channelAccounts/{channelAccountId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId) && request.resource.data.userId == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.userId == userId;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Controls access to content ideas generated by a user.
     * @path /users/{userId}/contentIdeas/{contentIdeaId}
     * @allow (create) User with ID 'user123' can create a content idea. request.auth.uid == 'user123'
     * @allow (get) User with ID 'user123' can read their content idea. request.auth.uid == 'user123'
     * @allow (update) User with ID 'user123' can update their content idea. request.auth.uid == 'user123'
     * @allow (delete) User with ID 'user123' can delete their content idea. request.auth.uid == 'user123'
     * @deny (create) User with ID 'user456' cannot create a content idea for 'user123'. request.auth.uid != 'user123'
     * @deny (get) User with ID 'user456' cannot read the content idea of 'user123'. request.auth.uid != 'user123'
     * @deny (update) User with ID 'user456' cannot update the content idea of 'user123'. request.auth.uid != 'user123'
     * @deny (delete) User with ID 'user456' cannot delete the content idea of 'user123'. request.auth.uid != 'user123'
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId}/contentIdeas/{contentIdeaId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId) && request.resource.data.userId == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.userId == userId;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Controls access to WhatsApp session data for a user.
     * @path /users/{userId}/whatsAppSessions/{sessionId}
     * @allow (create) User with ID 'user123' can create a WhatsApp session. request.auth.uid == 'user123'
     * @allow (get) User with ID 'user123' can read their WhatsApp session. request.auth.uid == 'user123'
     * @allow (update) User with ID 'user123' can update their WhatsApp session. request.auth.uid == 'user123'
     * @allow (delete) User with ID 'user123' can delete their WhatsApp session. request.auth.uid == 'user123'
     * @deny (create) User with ID 'user456' cannot create a WhatsApp session for 'user123'. request.auth.uid != 'user123'
     * @deny (get) User with ID 'user456' cannot read the WhatsApp session of 'user123'. request.auth.uid != 'user123'
     * @deny (update) User with ID 'user456' cannot update the WhatsApp session of 'user123'. request.auth.uid != 'user123'
     * @deny (delete) User with ID 'user456' cannot delete the WhatsApp session of 'user123'. request.auth.uid != 'user123'
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId}/whatsAppSessions/{sessionId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId) && request.resource.data.userId == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.userId == userId;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Controls access to video metrics associated with a channel account.
     * @path /channelAccounts/{channelAccountId}/videoMetrics/{videoMetricsId}
     * @allow (create) Any authenticated user can create video metrics.
     * @allow (get) Any authenticated user can read video metrics.
     * @allow (update) Any authenticated user can update video metrics.
     * @allow (delete) Any authenticated user can delete video metrics.
     * @principle Allows any authenticated user to perform any operation.
     */
    match /channelAccounts/{channelAccountId}/videoMetrics/{videoMetricsId} {
      allow get: if isSignedIn();
      allow list: if false;
      allow create: if isSignedIn();
      allow update: if isSignedIn() && resource != null;
      allow delete: if isSignedIn() && resource != null;
    }

    /**
     * @description Controls access to trending events. Public read, no write access.
     * @path /trendEvents/{trendEventId}
     * @allow (get) Any user can read trending events.
     * @deny (create) No user can create trending events.
     * @deny (update) No user can update trending events.
     * @deny (delete) No user can delete trending events.
     * @principle Allows public read access, restricts write access.
     */
    match /trendEvents/{trendEventId} {
      allow get: if true;
      allow list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Controls access to subscription data.
     * @path /subscriptions/{subscriptionId}
     * @allow (create) Any authenticated user can create a subscription.
     * @allow (get) Any authenticated user can read a subscription.
     * @allow (update) Any authenticated user can update a subscription.
     * @allow (delete) Any authenticated user can delete a subscription.
     * @principle Allows any authenticated user to perform any operation.
     */
    match /subscriptions/{subscriptionId} {
      allow get: if isSignedIn();
      allow list: if false;
      allow create: if isSignedIn();
      allow update: if isSignedIn() && resource != null;
      allow delete: if isSignedIn() && resource != null;
    }

    /**
     * @description Controls access to keyword data. Public read, no write access.
     * @path /keywords/{keywordId}
     * @allow (get) Any user can read keyword data.
     * @deny (create) No user can create keyword data.
     * @deny (update) No user can update keyword data.
     * @deny (delete) No user can delete keyword data.
     * @principle Allows public read access, restricts write access.
     */
    match /keywords/{keywordId} {
      allow get: if true;
      allow list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Controls access to competitor data. Public read, no write access.
     * @path /competitors/{competitorId}
     * @allow (get) Any user can read competitor data.
     * @deny (create) No user can create competitor data.
     * @deny (update) No user can update competitor data.
     * @deny (delete) No user can delete competitor data.
     * @principle Allows public read access, restricts write access.
     */
    match /competitors/{competitorId} {
      allow get: if true;
      allow list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }
  }

  // Helper functions
  function isSignedIn() {
    return request.auth != null;
  }

  function isOwner(userId) {
    return request.auth.uid == userId;
  }

  function isExistingOwner(userId) {
    return isOwner(userId) && resource != null;
  }
}